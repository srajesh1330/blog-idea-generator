<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trend Scout: Blog Idea Generator</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom styles for aesthetic */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .card {
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        }
        .btn-primary {
            transition: background-color 0.3s, transform 0.1s;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
        }
        .loading-ring {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffffff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Mobile adjustments */
        @media (max-width: 640px) {
            .input-group > * {
                flex: 1 1 100%; /* Full width on mobile */
                margin-bottom: 1rem;
            }
            .input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <!-- Firebase SDK Imports (MUST be type="module") -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // ONLY import necessary Firestore functions
        import { getFirestore, onSnapshot, collection, query, addDoc, serverTimestamp, orderBy, limit, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL SETUP (Required by Canvas) ---
        // 1. Get Environment Variables
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let userId = 'initializing';
        
        setLogLevel('Debug'); // Enable Firestore logging

        // 2. Initialize Firebase and Authentication
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config not found. Cannot initialize Firestore.");
                document.getElementById('auth-status').innerHTML = '<span class="text-red-500">Error: Firebase config missing.</span>';
                // Note: We intentionally don't return here to allow the non-Firestore parts of the app to run.
            } else {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // --- EXPOSE FIRESTORE FUNCTIONS TO GLOBAL WINDOW ---
                    window.query = query;
                    window.orderBy = orderBy;
                    window.limit = limit;
                    window.onSnapshot = onSnapshot;
                    window.addDoc = addDoc;
                    window.serverTimestamp = serverTimestamp;
                    window.db = db;
                    window.auth = auth;
                    
                    // Handle initial authentication
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }

                    // Listen for Auth State Changes
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('auth-status').innerHTML = 
                                `<span class="text-green-600">Authenticated.</span> User ID: <code class="bg-gray-100 p-1 rounded text-xs">${userId}</code>`;
                            window.userId = userId; // Set global userId
                            window.initApp(); // Start app logic after auth
                        } else {
                            userId = 'anonymous-' + crypto.randomUUID();
                            document.getElementById('auth-status').innerHTML = 
                                `<span class="text-yellow-600">Anonymous Session.</span> ID: <code class="bg-gray-100 p-1 rounded text-xs">${userId}</code>`;
                            window.userId = userId; // Set global userId
                            window.initApp(); // Start app logic after auth
                        }
                    });

                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    document.getElementById('auth-status').innerHTML = 
                        `<span class="text-red-500">Error: Authentication failed.</span>`;
                }
            }
            
            // If Firebase didn't initialize, we still need to run the app logic to allow API calls
            if (!db) {
                window.initApp(); 
            }
        }
        
        initializeFirebase();

        // 3. Firestore Path Helper
        window.getHistoryCollectionRef = () => {
             // Check if db is available before trying to access collection
            if (!window.db) return null; 
             // Storing history as private data under the user's ID
            return collection(window.db, 'artifacts', appId, 'users', window.userId, 'trend_scout_history');
        };

    </script>

    <!-- Main Application UI -->
    <header class="w-full max-w-4xl mb-6 text-center">
        <h1 class="text-4xl font-extrabold text-gray-900 flex items-center justify-center mb-2">
            <i data-lucide="sparkles" class="w-8 h-8 text-indigo-500 mr-3"></i>
            Trend Scout
        </h1>
        <p class="text-lg text-gray-600">Your AI-Powered Blog Idea Generator</p>
        <div id="auth-status" class="mt-2 text-sm text-gray-500">Initializing services...</div>
    </header>

    <main class="w-full max-w-4xl bg-white p-6 sm:p-8 rounded-xl card transition-all duration-300">
        
        <!-- Input Controls -->
        <section class="mb-8">
            <div class="input-group flex flex-wrap gap-4 mb-6">
                
                <!-- Region Selector -->
                <div class="flex-1 min-w-[200px]">
                    <label for="region" class="block text-sm font-medium text-gray-700 mb-1">Target Region</label>
                    <div class="relative">
                        <i data-lucide="globe" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-indigo-400"></i>
                        <select id="region" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                            <option value="Global">Global Trends</option>
                            <option value="North America">North America</option>
                            <option value="Europe">Europe</option>
                            <option value="Asia Pacific">Asia Pacific</option>
                            <option value="Latin America">Latin America</option>
                        </select>
                    </div>
                </div>

                <!-- Niche Selector -->
                <div class="flex-1 min-w-[200px]">
                    <label for="niche" class="block text-sm font-medium text-gray-700 mb-1">Blogging Niche</label>
                    <div class="relative">
                        <i data-lucide="edit" class="w-5 h-5 absolute left-3 top-1/2 transform -translate-y-1/2 text-indigo-400"></i>
                        <select id="niche" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out">
                            <option value="Technology & AI">Technology & AI</option>
                            <option value="Finance & Investing">Finance & Investing</option>
                            <option value="Health & Wellness">Health & Wellness</option>
                            <option value="Travel & Lifestyle">Travel & Lifestyle</option>
                            <option value="Food & Cooking">Food & Cooking</option>
                            <option option value="Sustainability & Climate">Sustainability & Climate</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Action Button -->
            <button id="generate-button" class="btn-primary w-full flex items-center justify-center bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-xl shadow-md transition duration-200" onclick="fetchTrends()">
                <i data-lucide="zap" class="w-5 h-5 mr-2"></i>
                What's Trending TODAY?
            </button>
        </section>

        <!-- Loading / Results Area -->
        <section>
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
                <i data-lucide="lightbulb" class="w-5 h-5 mr-2 text-yellow-500"></i>
                Latest Blog Ideas
            </h2>

            <!-- Loading Indicator -->
            <div id="loading-indicator" class="hidden flex flex-col items-center justify-center p-8 bg-indigo-50 rounded-lg">
                <div class="loading-ring mb-4"></div>
                <p class="text-indigo-700 font-medium">Scouting the digital landscape for fresh ideas...</p>
            </div>

            <!-- Error Message Box -->
            <div id="error-message" class="hidden p-4 mb-4 text-red-700 bg-red-100 rounded-lg border border-red-300" role="alert">
                <p class="font-bold">Error:</p>
                <p id="error-text"></p>
            </div>

            <!-- Results Content -->
            <div id="results-container" class="space-y-6">
                <div id="placeholder-message" class="p-6 bg-gray-50 rounded-lg text-center text-gray-500 italic">
                    Use the controls above and hit the "What's Trending TODAY?" button to generate cutting-edge blog post ideas based on real-time web data.
                </div>
                <!-- Generated trends will be inserted here -->
            </div>
        </section>
    </main>
    
    <!-- History Section -->
    <section class="w-full max-w-4xl mt-8 p-6 sm:p-8 bg-white rounded-xl card">
        <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2 flex items-center">
            <i data-lucide="history" class="w-5 h-5 mr-2 text-gray-500"></i>
            Idea History
        </h2>
        <div id="history-container" class="space-y-4">
            <!-- History items will be loaded here -->
            <p id="history-placeholder" class="text-gray-500 italic text-center">Loading past ideas...</p>
        </div>
    </section>
    
    <!-- Main Application Script -->
    <script>
        // Use a default model name here
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";
        const API_KEY = ""; // Required to be empty for Canvas to inject the token
        
        let appInitialized = false;

        // --- Core API Functions ---

        // 1. Exponential Backoff Retry Fetch
        async function fetchWithRetry(url, options, maxRetries = 6) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);

                    if (response.ok) {
                        return response;
                    }

                    // Handle 429 Too Many Requests or other transient errors
                    if (response.status === 429 || response.status >= 500) {
                        // Throw error to trigger retry and exponential backoff
                        throw new Error(`Server status: ${response.status}`);
                    }
                    
                    // Handle 403 Forbidden specifically (Authorization Error)
                    if (response.status === 403) {
                         throw new Error(`Authorization Error: 403 Forbidden. The key or token is invalid or missing.`);
                    }

                    // For other non-OK status codes (like 400 or 404), return the response to be handled by the caller
                    return response; 

                } catch (error) {
                    console.error(`Attempt ${i + 1} failed:`, error.message);
                    
                    if (i === maxRetries - 1) {
                        // If all retries are exhausted, include the last failure message for better diagnosis.
                        throw new Error(`Failed to connect to the API after multiple retries. Last known error: ${error.message}`);
                    }

                    // Exponential backoff delay (1s, 2s, 4s, 8s, 16s, ...)
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // 2. Main Content Generation Function
        async function generateContent(systemPrompt, userQuery, model) {
            const apiKey = API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                // IMPORTANT: Use Google Search grounding for real-time trends
                tools: [{ "google_search": {} }], 
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                // Optional: set a lower temperature for predictable, focused results
                config: {
                    temperature: 0.5
                }
            };

            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    // Include the failing status in the error for clarity
                    throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    
                    // 3. Extract Grounding Sources (Citations)
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }
                    return { text, sources };

                } else {
                    console.error("Unexpected API response structure:", result);
                    throw new Error("Could not extract content from the API response.");
                }

            } catch (error) {
                // Rethrow the error to be caught by the calling function (fetchTrends)
                throw error; 
            }
        }

        // 3. UI and Logic Functions

        function showLoading(isLoading) {
            const button = document.getElementById('generate-button');
            const loadingIndicator = document.getElementById('loading-indicator');
            const icon = lucide.createIcons();

            if (isLoading) {
                button.disabled = true;
                button.innerHTML = `
                    <div class="loading-ring mr-2"></div>
                    Generating Ideas...
                `;
                loadingIndicator.classList.remove('hidden');
                document.getElementById('error-message').classList.add('hidden');
                document.getElementById('placeholder-message').classList.add('hidden');
                document.getElementById('results-container').innerHTML = ''; // Clear old results
            } else {
                button.disabled = false;
                button.innerHTML = `<i data-lucide="zap" class="w-5 h-5 mr-2"></i> What's Trending TODAY?`;
                loadingIndicator.classList.add('hidden');
                // Re-render lucide icons after updating innerHTML
                lucide.createIcons(); 
            }
        }

        function displayError(message) {
            const errorDiv = document.getElementById('error-message');
            document.getElementById('error-text').textContent = message;
            errorDiv.classList.remove('hidden');
        }

        function renderTrendCard(idea) {
            const sourcesHtml = idea.sources.length > 0
                ? `<div class="mt-3 pt-3 border-t border-gray-100">
                      <p class="text-xs font-semibold text-gray-500 mb-1">Sources Grounding this data:</p>
                      <ul class="space-y-1">
                          ${idea.sources.map(s => `
                              <li>
                                  <a href="${s.uri}" target="_blank" class="text-xs text-indigo-600 hover:text-indigo-800 underline flex items-center">
                                      <i data-lucide="link" class="w-3 h-3 mr-1"></i>
                                      ${s.title}
                                  </a>
                              </li>
                          `).join('')}
                      </ul>
                  </div>`
                : `<div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-400 italic">No specific external sources cited for this response.</div>`;

            return `
                <div class="bg-indigo-50 p-6 rounded-xl shadow-inner border border-indigo-200">
                    <div class="flex items-center mb-3">
                        <i data-lucide="trending-up" class="w-6 h-6 text-indigo-600 mr-3"></i>
                        <h3 class="text-lg font-bold text-indigo-900">${idea.niche} Trend for ${idea.region}</h3>
                    </div>
                    <div class="prose max-w-none text-gray-700">
                        ${idea.content.replace(/\n/g, '<br>')}
                    </div>
                    ${sourcesHtml}
                </div>
            `;
        }

        async function fetchTrends() {
            showLoading(true);
            const region = document.getElementById('region').value;
            const niche = document.getElementById('niche').value;

            const systemPrompt = `You are a professional blog idea scout. Your job is to analyze current web trends using the Google Search tool and generate ONE compelling, high-quality blog post idea based on the user's selected niche and region. The idea MUST be timely and based on verifiable, real-world data. Present the idea in a direct, engaging paragraph, explaining the topic, the target audience, and the potential value. DO NOT use markdown lists, headings, or any formatting other than paragraph text.`;

            const userQuery = `Generate one cutting-edge blog post idea for the niche "${niche}" that is highly relevant to current news and search trends in the "${region}" region.`;

            try {
                const { text, sources } = await generateContent(systemPrompt, userQuery, MODEL_NAME);
                
                const newIdea = {
                    region: region,
                    niche: niche,
                    content: text,
                    sources: sources,
                    timestamp: new Date()
                };

                // --- Persistence Logic: Only run if Firestore is available ---
                const historyRef = window.getHistoryCollectionRef();
                if (historyRef) {
                    // Use exposed functions from window
                    await window.addDoc(historyRef, {
                        ...newIdea,
                        timestamp: window.serverTimestamp()
                    });
                } else {
                     console.warn("History saving skipped: Firebase not fully initialized due to missing config.");
                }

                // Display the new idea immediately
                const resultsContainer = document.getElementById('results-container');
                resultsContainer.innerHTML = renderTrendCard(newIdea);
                lucide.createIcons(); // Re-render icons

            } catch (error) {
                console.error("Error fetching trends:", error);
                
                // Enhanced error diagnostics for connection failures
                if (error.message.includes("403 Forbidden")) {
                    displayError(`Authorization Error (403 Forbidden): The system failed to connect securely to the API. Please ensure you are running the app in the authorized environment.`);
                } else if (error.message.includes("Failed to connect to the API after multiple retries.")) {
                    // Specific message for the failure reported by the user
                    displayError(`Connection Failure: The app could not reach the Gemini API after multiple retries. This is usually due to a temporary network issue or a firewall block. Please check your connection and try again.`);
                }
                else {
                    displayError(error.message);
                }
            } finally {
                showLoading(false);
            }
        }

        // 4. History Rendering Function
        function renderHistory(snapshot) {
            const historyContainer = document.getElementById('history-container');
            if (!historyContainer) return;

            if (snapshot.empty) {
                historyContainer.innerHTML = `<p class="text-gray-500 italic text-center">No history yet. Generate your first idea!</p>`;
                return;
            }
            
            let html = '';
            snapshot.forEach(doc => {
                const data = doc.data();
                const date = data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Loading...';
                
                // Truncate content for the history view
                const snippet = data.content.substring(0, 150) + (data.content.length > 150 ? '...' : '');

                html += `
                    <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-md font-semibold text-gray-800">${data.niche} Idea (${data.region})</h4>
                            <span class="text-xs text-gray-500">${date}</span>
                        </div>
                        <p class="text-sm text-gray-600 italic">${snippet}</p>
                    </div>
                `;
            });

            historyContainer.innerHTML = html;
        }


        // 5. App Initialization (called after Firebase Auth is ready)
        window.initApp = function() {
            if (appInitialized) return;
            appInitialized = true;

            // Load icons for the initial UI
            lucide.createIcons();
            
            // Set up History Listener ONLY if history services are available
            const historyRef = window.getHistoryCollectionRef();
            if (historyRef && window.query && window.orderBy && window.limit && window.onSnapshot) {
                const historyQuery = window.query(historyRef, window.orderBy('timestamp', 'desc'), window.limit(10));
    
                // Real-time listener for history updates - use window.onSnapshot
                window.onSnapshot(historyQuery, (snapshot) => {
                    renderHistory(snapshot);
                }, (error) => {
                    console.error("Error listening to history:", error);
                    document.getElementById('history-container').innerHTML = `<p class="text-red-500 text-center">Failed to load history.</p>`;
                });
            } else {
                // Update history placeholder if Firebase is known to be missing
                if (!window.db) {
                    document.getElementById('history-container').innerHTML = `<p class="text-gray-500 italic text-center">History disabled: Firebase configuration is missing.</p>`;
                }
            }
            
            // Expose fetchTrends globally for the button click
            window.fetchTrends = fetchTrends;
        };

    </script>

</body>
</html>
